<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>MIDI → Minecraft NoteBlock PRO</title>
<style>
body { font-family:sans-serif; padding:2rem; background:#f0f2f5; }
#dropZone { border:2px dashed #4b6cb7; padding:2rem; text-align:center; margin-bottom:1rem; cursor:pointer; }
#dropZone.hover { background:#4b6cb7; color:white; }
table { width:100%; border-collapse:collapse; margin-top:1rem; }
th, td { padding:0.4rem; border:1px solid #ccc; font-size:13px; }
thead { background:#4b6cb7; color:white; }
button { padding:0.5rem 1rem; margin:0.5rem 0; cursor:pointer; }
.info { margin-top:10px; font-weight:bold; }
</style>
</head>
<body>

<h1>MIDI → Minecraft NoteBlock (Preciso con BPM)</h1>

<div id="dropZone">Arrastra tu archivo MIDI aquí</div>
<input type="file" id="fileInput" accept=".mid">
<br>
<button id="processBtn">Procesar MIDI</button>

<div class="info" id="midiInfo"></div>

<table>
<thead>
<tr>
<th>Tick</th>
<th>Delta Tick</th>
<th>Tiempo (s)</th>
<th>Nota MIDI</th>
<th>Instrumento</th>
<th>NoteBlock (0-24)</th>
</tr>
</thead>
<tbody id="resultBody"></tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/build/Midi.js"></script>
<script>

const gmToMC = {
  1:{name:"Piano",octave:0},
  25:{name:"Guitar",octave:1},
  33:{name:"Bass",octave:2},
  74:{name:"Flute",octave:-1},
  81:{name:"Bit",octave:0},
  106:{name:"Banjo",octave:0}
};

function clampMC(n){ return Math.max(0, Math.min(24, n)); }

let midiFile=null;
const dropZone=document.getElementById('dropZone');
const fileInput=document.getElementById('fileInput');
const resultBody=document.getElementById('resultBody');
const midiInfo=document.getElementById('midiInfo');

dropZone.addEventListener('dragover',e=>{ e.preventDefault(); dropZone.classList.add('hover'); });
dropZone.addEventListener('dragleave',e=>{ e.preventDefault(); dropZone.classList.remove('hover'); });
dropZone.addEventListener('drop',e=>{ e.preventDefault(); dropZone.classList.remove('hover');
  if(e.dataTransfer.files.length){ midiFile=e.dataTransfer.files[0]; dropZone.textContent="Cargado: "+midiFile.name; }
});
fileInput.addEventListener('change',e=>{ if(e.target.files.length){ midiFile=e.target.files[0]; dropZone.textContent="Cargado: "+midiFile.name; } });

async function processMidi(){
  if(!midiFile){ alert("Carga un MIDI primero."); return; }

  resultBody.innerHTML="";
  midiInfo.innerHTML="";

  const buffer=await midiFile.arrayBuffer();
  const midi=new Midi(buffer);

  const ppq = midi.header.ppq;
  const tempoEvents = midi.header.tempos;

  let bpm = 120;
  if(tempoEvents.length > 0){
    bpm = tempoEvents[0].bpm;
  }

  midiInfo.innerHTML = `
  PPQ: ${ppq} | BPM inicial: ${bpm} | Cambios de tempo: ${tempoEvents.length}
  `;

  let notesAll=[];

  midi.tracks.forEach(track=>{
    const programNumber = track.instrument?.number 
        ? track.instrument.number+1 
        : 1;

    track.notes.forEach(note=>{
      const tick = note.ticks;   // ✅ TICKS REALES DEL MIDI
      const midiPitch = note.midi;

      const info = gmToMC[programNumber] || {name:"Harp",octave:0};

      let mcPitch = clampMC(
          Math.round(midiPitch - 60 + 12 + info.octave*12)
      );

      notesAll.push({
        tick: tick,
        time: note.time,
        midi: midiPitch,
        instrument: info.name,
        mc: mcPitch
      });
    });
  });

  // Ordenar por tick real
  notesAll.sort((a,b)=>a.tick-b.tick);

  let lastTick = 0;

  notesAll.forEach(n=>{
    const delta = n.tick - lastTick;
    lastTick = n.tick;

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${n.tick}</td>
      <td>${delta}</td>
      <td>${n.time.toFixed(4)}</td>
      <td>${n.midi}</td>
      <td>${n.instrument}</td>
      <td>${n.mc}</td>
    `;
    resultBody.appendChild(tr);
  });
}

document.getElementById('processBtn').addEventListener('click',processMidi);

</script>
</body>
</html>
