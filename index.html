processBtn.addEventListener("click", async () => {
  if(!midiFile) return alert("Please load a MIDI file first!");

  const arrayBuffer = await midiFile.arrayBuffer();
  const midi = new Midi(arrayBuffer);

  let tickYMap = {};
  let schematicBlocks = [];

  midi.tracks.forEach(track => {
    track.notes.forEach(note => {
      const tick = Math.floor(note.ticks);
      const instrument = note.name || "Harp";
      const mcBlock = instrumentToBlock[instrument] || "minecraft:gold_block";

      if(!tickYMap[tick]) tickYMap[tick] = 0;
      const y = tickYMap[tick];
      tickYMap[tick] = (tickYMap[tick] + 1) % 3; // hasta 3 notas por tick

      schematicBlocks.push({
        block: mcBlock,
        tick: tick,
        note: Math.min(24, Math.floor(note.midi - 60)),
        y: y + 1
      });
    });
  });

  // Mostrar output en JSON
  output.innerHTML = `<pre>${JSON.stringify(schematicBlocks, null, 2)}</pre>`;

  // Crear botÃ³n de descarga
  let downloadBtn = document.getElementById("downloadSchemBtn");
  if(!downloadBtn) {
    downloadBtn = document.createElement("button");
    downloadBtn.id = "downloadSchemBtn";
    downloadBtn.textContent = "Download Schematic (.json)";
    downloadBtn.style.marginTop = "1rem";
    processBtn.after(downloadBtn);

    downloadBtn.addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(schematicBlocks, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "notetrasform.schem.json";
      a.click();
      URL.revokeObjectURL(url);
    });
  }
});
