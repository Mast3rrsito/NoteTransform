<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>MIDI → Minecraft PRO</title>
<script src="https://cdn.jsdelivr.net/npm/@tonejs/midi@2.0.27/build/Midi.js"></script>
<style>
body{font-family:sans-serif;background:#f4f6fa;padding:20px}
table{width:100%;border-collapse:collapse;margin-top:20px;background:white}
th,td{border:1px solid #ddd;padding:6px;font-size:13px}
thead{background:#222;color:white}
button{padding:6px 12px;margin-top:10px}
</style>
</head>
<body>

<h2>MIDI → Minecraft NoteBlock Mapper (GM 2025)</h2>

<input type="file" id="fileInput" accept=".mid">
<button onclick="processMidi()">Procesar</button>

<table>
<thead>
<tr>
<th>Tick</th>
<th>Delta</th>
<th>Nota</th>
<th>Bloque</th>
<th>ID</th>
<th>NoteBlock#</th>
</tr>
</thead>
<tbody id="result"></tbody>
</table>

<script>

// ===============================
// NOTE NAMES
// ===============================

const NOTE_NAMES=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
function midiToNoteName(n){
    return NOTE_NAMES[n%12]+(Math.floor(n/12)-1);
}

// ===============================
// BASE MC INSTRUMENT LIST
// ===============================

const MC_BLOCKS = {
0:"Harp",
1:"Bass",
2:"Bass Drum",
3:"Snare Drum",
4:"Click",
5:"Guitar",
6:"Flute",
7:"Bell",
8:"Chime",
9:"Xylophone",
10:"Iron Xylophone",
11:"Cow Bell",
12:"Didgeridoo",
13:"Bit",
14:"Banjo",
15:"Pling"
};

// ===============================
// GM → MC MAPPING (RESUMEN EXACTO TABLA)
// Solo primer instrumento recomendado
// ===============================

function mapProgramToMC(program){

// Pianos
if(program==1) return {id:0,shift:0};
if(program==2||program==3||program==4) return {id:15,shift:0};

// Guitar
if(program>=25&&program<=32) return {id:5,shift:1};

// Bass
if(program>=33&&program<=40) return {id:1,shift:2};

// Strings / Ensemble / Choir
if(program>=41&&program<=56) return {id:6,shift:-1};

// Brass
if(program>=57&&program<=64) return {id:6,shift:-1};

// Reed
if(program>=65&&program<=72) return {id:6,shift:-1};

// Pipe
if(program>=73&&program<=80) return {id:6,shift:-1};

// Synth Lead
if(program>=81&&program<=88) return {id:13,shift:0};

// Synth Pad
if(program>=89&&program<=96) return {id:6,shift:-1};

// FX
if(program>=97&&program<=104) return {id:8,shift:-2};

// Ethnic
if(program>=105&&program<=112) return {id:14,shift:0};

// Percussive instruments (melodic)
if(program>=113&&program<=120) return {id:2,shift:0};

// Default
return {id:0,shift:0};
}

// ===============================
// PERCUSSION MAP (CANAL 10)
// Simplificado usando tu tabla oficial
// ===============================

function mapDrumToMC(note){

// Kick
if(note==35||note==36) return {id:2,pitch:4};

// Snare
if(note==38||note==40) return {id:3,pitch:15};

// HiHat
if(note==42||note==44) return {id:4,pitch:21};

// Tom
if(note>=41&&note<=50) return {id:2,pitch:8};

// Default snare
return {id:3,pitch:12};
}

// ===============================
// MIDI → NoteBlock number
// Centro MC ≈ F#3 (54)
// ===============================

function midiToNoteBlock(midi,shift){

let nb = midi - 54 + (shift*12);

if(nb<0) nb=0;
if(nb>24) nb=24;

return nb;
}

// ===============================
// MAIN PROCESS
// ===============================

async function processMidi(){

const fileInput=document.getElementById("fileInput");
const result=document.getElementById("result");
result.innerHTML="";

if(!fileInput.files.length){
alert("Carga un MIDI");
return;
}

const buffer=await fileInput.files[0].arrayBuffer();
const midi=new Midi(buffer);

let notes=[];

midi.tracks.forEach(track=>{

const program=track.instrument.number+1;
const isDrum=track.channel==9;

track.notes.forEach(n=>{
notes.push({
tick:n.ticks,
time:n.time,
midi:n.midi,
program:program,
isDrum:isDrum
});
});
});

notes.sort((a,b)=>a.tick-b.tick||a.time-b.time);

let lastTick=notes[0]?.tick||0;

notes.forEach((n,i)=>{

let delta=i==0?0:n.tick-lastTick;
lastTick=n.tick;

let blockData;
let noteNumber;

if(n.isDrum){

blockData=mapDrumToMC(n.midi);
noteNumber=blockData.pitch;

}else{

blockData=mapProgramToMC(n.program);
noteNumber=midiToNoteBlock(n.midi,blockData.shift);
}

let row=document.createElement("tr");
row.innerHTML=`
<td>${n.tick}</td>
<td>${delta}</td>
<td>${midiToNoteName(n.midi)}</td>
<td>${MC_BLOCKS[blockData.id]}</td>
<td>${blockData.id}</td>
<td>${noteNumber}</td>
`;

result.appendChild(row);

});

}

</script>
</body>
</html>
